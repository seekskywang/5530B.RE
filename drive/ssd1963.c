/******************************************************************/
/* ƒª‘Üƒà                                          					    */
/* –ß⁄ª√∫                                                        */
/* ≈ö…ù√∫ ssd1963»Ω÷Ø‘å—≤																		    */
/* ÿ∑÷ü√∫n÷±                                                    */
/* jœµ◊Ω Ω√∫QQ:363116119                                        */
/******************************************************************/
#include "stm32f4xx.h"
#include <stdint.h>
#include "stm32f4xx_fsmc.h"
#include "ssd1963.h"
#include "my_register.h"
#include "stm32f4xx_gpio.h"
#include "stm32f4xx_rcc.h"

/******************************************************************/
vu32     HDP=479;

vu32     HT=531;
vu32     HPS=43;
vu32     LPS=8;
vu8      HPW=10;

vu32     VDP=271;

vu32     VT=288;
vu32     VPS=12;
vu32     FPS=4;
vu8      VPW=10;

void sLCD_WR_REG(unsigned int index)
{
	*(__IO u16 *) (Bank1_LCD_C)= index;

}

void sLCD_WR_Data(unsigned int val)
{   
	*(__IO u16 *) (Bank1_LCD_D)= val; 	
}

vu16 sLCD_Read_Data(void)
{
 

   return  *(__IO u16 *) (Bank1_LCD_D);

     
}

void sLCD_OpenWindow(vu32 x1, vu32 y1, vu32 x2, vu32 y2)
{
	sLCD_WR_REG(0x002a);
	sLCD_WR_Data(x1>>8);
	sLCD_WR_Data(x1);
	sLCD_WR_Data(x2>>8);
	sLCD_WR_Data(x2);

	sLCD_WR_REG(0x002b);
	sLCD_WR_Data(y1>>8);
	sLCD_WR_Data(y1);
	sLCD_WR_Data(y2>>8);
	sLCD_WR_Data(y2);
	sLCD_WR_REG(0x002C);
}

vu16 sLCD_BGR2RGB(vu16 c)
{
  vu16  r, g, b, rgb;

  b = (c>>0)  & 0x1f;
  g = (c>>5)  & 0x3f;
  r = (c>>11) & 0x1f;
  
  rgb =  (b<<11) + (g<<5) + (r<<0);

  return( rgb );
}

void Delay_usS(vu16 ustime)
{
  vu16 ii,jj;

  for (ii=0; ii<ustime; ++ii)
  {
    jj=4;
    do
    {
      NOP;
			NOP;
			NOP;
			NOP;
			NOP;
    }while (--jj);
  }
}
void  Delay_ms(vu16 mstime)
{                                                           
  while (mstime--)
  {
    Delay_usS(1000);
  }
}
void sLCD_GPIO_Config(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;//
    
		GPIO_PinAFConfig(GPIOD,GPIO_PinSource7,GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD,GPIO_PinSource11,GPIO_AF_FSMC);
	
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource0, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource1, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource4, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource5, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource8, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource9, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource10, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource14, GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOD, GPIO_PinSource15, GPIO_AF_FSMC);
	

		GPIO_PinAFConfig(GPIOE, GPIO_PinSource7 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource8 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource9 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource10 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource11 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource12 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource13 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource14 , GPIO_AF_FSMC);
		GPIO_PinAFConfig(GPIOE, GPIO_PinSource15 , GPIO_AF_FSMC);
    /*
        FSMC Data ⁄úﬁÖ‘µ º€Ø D0~D15
    */
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_14 | GPIO_Pin_15 | GPIO_Pin_8 | 
                                    GPIO_Pin_9 | GPIO_Pin_10 | GPIO_Pin_0 |
                                    GPIO_Pin_1 ;
    GPIO_InitStructure.GPIO_Speed =GPIO_Speed_100MHz;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
		GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//ŒÜŒ¨À§‘∂
		GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init(GPIOD, &GPIO_InitStructure);

    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7 | GPIO_Pin_8 | GPIO_Pin_9 | 
                                    GPIO_Pin_10 | GPIO_Pin_11 | GPIO_Pin_12 |
                                    GPIO_Pin_13 | GPIO_Pin_14 | GPIO_Pin_15 ;
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
		GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//ŒÜŒ¨À§‘∂
		GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init(GPIOE, &GPIO_InitStructure);

    /*
        CS      RD      RW      RS
    */
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7 | GPIO_Pin_4 | GPIO_Pin_5 |
                                    GPIO_Pin_11;
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
		GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
		GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
    GPIO_Init(GPIOD, &GPIO_InitStructure);
		GPIO_ResetBits(GPIOD,GPIO_Pin_13);//RST_lcd
 }

 void sLCD_FSMC_Config(void)
{		
	FSMC_NORSRAMInitTypeDef  FSMC_NORSRAMInitStructure;
	FSMC_NORSRAMTimingInitTypeDef  FSMC_NORSRAMTimingInitStructure;

	RCC_AHB3PeriphClockCmd(RCC_AHB3Periph_FSMC,ENABLE);//ÂºÄÂêØFSMCÊó∂Èíü
	/*-- FSMC Configuration ------------------------------------------------------*/

	FSMC_NORSRAMTimingInitStructure.FSMC_AddressSetupTime = 8;
	FSMC_NORSRAMTimingInitStructure.FSMC_AddressHoldTime = 0;
	FSMC_NORSRAMTimingInitStructure.FSMC_DataSetupTime = 18;
	FSMC_NORSRAMTimingInitStructure.FSMC_BusTurnAroundDuration = 0x00;
	FSMC_NORSRAMTimingInitStructure.FSMC_CLKDivision = 0x00;
	FSMC_NORSRAMTimingInitStructure.FSMC_DataLatency = 0x00;
	FSMC_NORSRAMTimingInitStructure.FSMC_AccessMode = FSMC_AccessMode_A;

	/*
	 LCD configured as follow:
	    - Data/Address MUX = Disable
	    - Memory Type = SRAM
	    - Data Width = 16bit
	    - Write Operation = Enable
	    - Extended Mode = Enable
	    - Asynchronous Wait = Disable
	*/
	FSMC_NORSRAMInitStructure.FSMC_Bank = FSMC_Bank1_NORSRAM1;//  
  FSMC_NORSRAMInitStructure.FSMC_DataAddressMux = FSMC_DataAddressMux_Disable; // 
  FSMC_NORSRAMInitStructure.FSMC_MemoryType =FSMC_MemoryType_SRAM;// FSMC_MemoryType_SRAM;  //SRAM   
  FSMC_NORSRAMInitStructure.FSMC_MemoryDataWidth = FSMC_MemoryDataWidth_16b;//16BITÊï∞ÊçÆ
  FSMC_NORSRAMInitStructure.FSMC_BurstAccessMode =FSMC_BurstAccessMode_Disable;// FSMC_BurstAccessMode_Disable; 
  FSMC_NORSRAMInitStructure.FSMC_WaitSignalPolarity = FSMC_WaitSignalPolarity_Low;
	FSMC_NORSRAMInitStructure.FSMC_AsynchronousWait=FSMC_AsynchronousWait_Disable; 
  FSMC_NORSRAMInitStructure.FSMC_WrapMode = FSMC_WrapMode_Disable;   
  FSMC_NORSRAMInitStructure.FSMC_WaitSignalActive = FSMC_WaitSignalActive_BeforeWaitState;  
  FSMC_NORSRAMInitStructure.FSMC_WriteOperation = FSMC_WriteOperation_Enable;	// 
  FSMC_NORSRAMInitStructure.FSMC_WaitSignal = FSMC_WaitSignal_Disable;   
  FSMC_NORSRAMInitStructure.FSMC_ExtendedMode = FSMC_ExtendedMode_Enable; //
  FSMC_NORSRAMInitStructure.FSMC_WriteBurst = FSMC_WriteBurst_Disable; 

  FSMC_NORSRAMInit(&FSMC_NORSRAMInitStructure);  //

  FSMC_NORSRAMCmd(FSMC_Bank1_NORSRAM1, ENABLE);  //
}


void sLCD_Clear(u16 color)
{
    unsigned int l=480 ,w;
    /*
	sLCD_WR_REG(0x002A);	
	sLCD_WR_Data(0);	    
	sLCD_WR_Data(0);
	sLCD_WR_Data(HDP>>8);	    
	sLCD_WR_Data(HDP&0x00ff);
    sLCD_WR_REG(0x002b);	
	sLCD_WR_Data(0);	    
	sLCD_WR_Data(0);
	sLCD_WR_Data(VDP>>8);	    
	sLCD_WR_Data(VDP&0x00ff);
	*/
	sLCD_OpenWindow(0, 0, HDP, VDP);
	sLCD_WR_REG(0x002c);
    
	while(l--)
	{
	    for(w=0;w<272;w++)
		{    
			sLCD_WR_Data(color);
		//  sLCD_WR_Data(color);
		 // sLCD_WR_Data(color);
		}
	}
}

void sLCD_Init(void)
{
    vu16 DeviceCode;
    sLCD_WR_REG(0xa1);
    DeviceCode = sLCD_Read_Data();    
    DeviceCode = sLCD_Read_Data();    
    DeviceCode = sLCD_Read_Data();    
    DeviceCode = sLCD_Read_Data();    
    DeviceCode = sLCD_Read_Data();    
    DeviceCode = DeviceCode;
    //  Step 2: PLL ®◊É
    sLCD_WR_REG(0x00E2);     //0XE2Àá ®◊ÉPLL ÷Ñ›Ñ’¶«∑c
    sLCD_WR_Data(0x001D);// (0x002C);//   // ®◊É—∂∆µÀΩ M   0x21D for 10M
    sLCD_WR_Data(0x0002);    // ®◊Éÿñ∆µÀΩ N
    sLCD_WR_Data(0x0004);    // π≈úMN   PLL = INCLK*(M+1) / (N+1)  PLL —∂∆µ’Ω120M PLL=8*44/3=120M

    sLCD_WR_REG(0x00E0);     //0XE0ÀáPLL π≈ú›Ñ’¶«∑
    sLCD_WR_Data(0x0001);    //–àﬂ™«¥PLL
    Delay_ms(10);
	
    sLCD_WR_REG(0x00E0);     //€π“™“ª’é
    sLCD_WR_Data(0x0003);    //  π‘É PLLÿ∑Œ™ ±◊ì
    Delay_ms(10);
    sLCD_WR_REG(0x0001);     // …≠›æÿ¥Œª
    Delay_ms(10);

    //step 3 :  ®◊ÉPCLK√¨“≤ﬂçÀá–±Ãò ±◊ì
    sLCD_WR_REG(0xE6);        //·Ö£ÕÉ€¥úÅòE6Àá ®◊É–±Ãò ±◊ì÷Ñ›Ñ’¶«∑  
    sLCD_WR_Data(0x0001);//(0x01);//       //œí÷Ñ«ÅƒªÀá4.3’ß√¨÷¢Ÿ∂∆µ√äﬂç‡†â”î¬ã√¨…ß⁄ª«Åƒª“àﬁè’≥√¨‘ê ÅÀ∏÷Ñ€∞√¨‡†â”î’ô›ì’≥
    sLCD_WR_Data(0x0093);//(0x93);//
    sLCD_WR_Data(0x0032);// ( 0xE0);//     //Œº›áÀµ¬ã√¨›Ñ’¶«∑÷∏¬Æ÷ºÀá8Œª‘´À§÷Ñ√¨÷¢o÷Ñ–±Ãò ±◊ì—®“™3Ÿ∂ÿñﬁö4 ®◊É√¨ŸüŒª’ö«∞

    //step 4 :  ®◊ÉLCD÷Ñ–î æƒ£ Ω√¨—®“™Ÿπﬂù«Åƒª’≥–°€çLCD÷Ñ÷ß¬∑‡†ò◊Ü◊Ω◊®–†∆•∆§√¨
    sLCD_WR_REG(0x00B0);        // ®◊ÉLCD–î æƒ£ Ω‹∞ÿñ“¶√ä
    sLCD_WR_Data(0x0020);//(0x0018);        //  π≈úFRC 0X0018 18bit LCD‡†ò◊Ü 
    sLCD_WR_Data(0x0000);     //TFTƒ£ Ω
    sLCD_WR_Data((HDP>>8)&0X00FF);  //Set HDP         ÀÆ∆Ω’≥–°
    sLCD_WR_Data(HDP&0X00FF);             //À´ÿñﬁö√¨ŸüŒª’ö«∞
    sLCD_WR_Data((VDP>>8)&0X00FF);  //Set VDP         ‘π÷±‘ü’ß
    sLCD_WR_Data(VDP&0X00FF);
    sLCD_WR_Data(0x0000);                        //RGBÀ≥—≤‘Æ—êTFTﬁì‡†ö

    sLCD_WR_REG(0x00B4);        // ®◊É  ÀÆ∆Ω–î æ ±›§”éÀΩ
    sLCD_WR_Data((HT>>8)&0X00FF);  //Set HT ÀÆ∆Ωÿú◊ú«ö
    sLCD_WR_Data(HT&0X00FF);
    sLCD_WR_Data((HPS>>8)&0X00FF);  //Set HPS ÀÆ∆ΩÕ¨“Ω√∂‘•ﬂ™ ºŒª
    sLCD_WR_Data(HPS&0X00FF);
    sLCD_WR_Data(HPW);                           //Set HPW ÀÆ∆ΩÕ¨“Ω√∂‘•‡†≠◊à
    sLCD_WR_Data((LPS>>8)&0X00FF);  //Set LPS –î æﬂ™ ºŒª
    sLCD_WR_Data(LPS&0X00FF);
    sLCD_WR_Data(0x0000);         //TFT mode–Ç√¨…ß’ã ®◊É

    sLCD_WR_REG(0x00B6);        // ®◊É        ‘π÷±–î æ ±›§”éÀΩ
    sLCD_WR_Data((VT>>8)&0X00FF);   //Set VT ‘π÷±ÿú◊ú«ö
    sLCD_WR_Data(VT&0X00FF);
    sLCD_WR_Data((VPS>>8)&0X00FF);  //Set VPS ‘π÷±Õ¨“Ω√∂‘•ﬂ™ ºŒª
    sLCD_WR_Data(VPS&0X00FF);
    sLCD_WR_Data(VPW);                           //Set VPW‘π÷±Õ¨“Ω√∂‘•‡†≠◊à
    sLCD_WR_Data((FPS>>8)&0X00FF);  //Set FPS  –î æﬂ™ ºŒª◊É
    sLCD_WR_Data(FPS&0X00FF);
    
    sLCD_WR_REG(0X0036);    // ®◊É’ì◊∑‹∫◊Å»°÷∏¬ÆÀ≥—≤√¨‡†â”î °√î√¨ è÷ßƒ¨…èŒ™0
    sLCD_WR_Data(0X0000);
    sLCD_WR_REG(0x00F0); //pixel data interface   ®◊É–±ÃòÀΩﬂùﬁì‡†öŒ™16Œª
    sLCD_WR_Data(0x0003); //03Œ™ 565 ÷Ñ16ŒªÕ®—∂c
    
    //step 5 : ‡†â—°c ®◊ÉÕº—é€≥‘¶mc
    //sLCD_WR_REG(0x0021);        //ﬁ∏…´Õº—é“ï…´◊≠◊™ƒ£ Ω 

    //sLCD_WR_REG(0x00BC);// ®◊ÉÕº–±€≥‘¶m
    //sLCD_WR_Data(0x005A);//(0x0080);//◊î“à◊à
    //sLCD_WR_Data(0x0064);//(0x0080);//¬Å◊à
    //sLCD_WR_Data(0x005A);//(0x0080);//—•€ç◊à÷µ  //
    //sLCD_WR_Data(0x0001);//‘¶m‹∫’ä—≠

    //sLCD_Clear(0Xffff);//À¢‘â—ó…´
    //sLCD_Clear(0x0000000);//€ö…´
    sLCD_WR_REG(0x0029); //display on
    
//    // step 6 √¨—≥⁄¢ ®◊É√¨“≤Àá«Åƒª¬Å«∞4÷Ñ“ª“Ωc
//    sLCD_WR_REG(0x00BE); //set PWM‡†ò◊Ü
//    sLCD_WR_Data(0x0006);        //PWM∆µ√ä = PLL / (256* 0x06) /256        
//    sLCD_WR_Data(0x00ff); // PWM’º‡†ï“à ®◊É 
//    sLCD_WR_Data(0x09); //DBC ‡†ò◊ÜPWM  π≈ú 
//    sLCD_WR_Data(0xFF); //DBCÀñ÷Ø¬Å◊à ®◊É
//    sLCD_WR_Data(0x00); //DBC ÿÆ–°¬Å◊à ®◊É 
//    sLCD_WR_Data(0x00);
//
//    sLCD_WR_REG(0xD4); // ®◊É√øŸ∂÷à‹∂÷Ñ÷ß‘¥◊ß÷µ
//    //TH1 = display width * display height * 3 * 0.1 /16 
//    //480*272 * 3 * 0.1 /16 =990H
//    sLCD_WR_Data(0x00); // 
//    sLCD_WR_Data(0x09); // 
//    sLCD_WR_Data(0x90); // 
//  
//    //TH2 = display width * display height * 3 * 0.25 /16
//    //480*272 * 3 * 0.25 /16 =17E8H
//    sLCD_WR_Data(0x00); // 
//    sLCD_WR_Data(0xE8); // 
//
//    //TH3 = display width * display height * 3 * 0.6 /16 
//    //480*272 * 3 * 0.6 /16 =3960H
//    sLCD_WR_Data(0x00); // 
//    sLCD_WR_Data(0x39); // 
//    sLCD_WR_Data(0x60); //
//                 
//    sLCD_WR_REG(0x00d0);// ®◊É÷ØÃ¨—≥⁄¢‡†ò◊Ü∆§◊É 
//    sLCD_WR_Data(0x000d); 
}

void LCD_Initializtion(void)
{   
    sLCD_GPIO_Config();
    sLCD_FSMC_Config();
    NOP;
		NOP;
		NOP;NOP;
		NOP;
		NOP;
		NOP;
    sLCD_Init();
}

void LCD_SetPoint(vu16 x,vu16 y,vu16 c)
{
    sLCD_OpenWindow(x, y, x, y);
    sLCD_WR_REG(0x2c);
    sLCD_WR_Data(c);
}

vu16 LCD_GetPoint(vu16 x, vu16 y)
{
    vu16 temp;
    
    sLCD_OpenWindow(x, y, x, y);

    sLCD_WR_REG(0x2e);
    temp = sLCD_Read_Data();
    
	return temp;
}

